---
title: "MS2 chromatograms based alignment of targeted mass-spectrometry runs"
author: "Shubham Gupta and Hannes Röst"
package: DIAlignR
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: DIAlignR.bib
vignette: >
  %\VignetteIndexEntry{MS2 chromatograms based alignment of targeted mass-spectrometry runs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteKeywords{Retention time alignment, DIA, Targeted MS, mass spectrometry, proteomics, metabolomics}
  %\VignettePackage{DIAlignR}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this document we are presenting a workflow of retention-time alignment across multiple Targeted-MS (e.g. DIA, SWATH-MS, PRM, SRM) runs using DIAlignR. This tool requires MS2 chromatograms and provides a hybrid approach of global and local alignment to establish correspondence between peaks.

## Install DIAlignR
```{r installDIAlignR, eval=FALSE}
require(devtools)
install_github("Roestlab/DIAlignR")
```

```{r loadDIAlignR}
library(DIAlignR)
```

## Prepare input files for alignment
Mass-spectrometry files mostly contains spectra. Targeted proteomics workflow identifyies analytes from their chromatographic elution profile. DIAlignR extends the same concept for retention-time (RT) alignment and, therefore, relies on MS2 chromatograms. DIAlignR expects raw chromatogram file (.chrom.mzML) and FDR-scored features (.osw) file.  

|     To obtain files for alignment, following three steps are needed:  

* Step 1 Convert spectra files from vendor-specific format to standard mzMl format using [ProteoWizard-MSConvert](http://proteowizard.sourceforge.net/tools.shtml).    
* Step 2 Extract features and raw extracted-ion chromatograms(XICs) for library analytes. A detailed tutorial using [OpenSWATH](http://openswath.org/en/latest/docs/openswath.html) is available for this steps. In short, following `bash` command can be used:  
    
```{bash, eval=FALSE}
OpenSwathWorkflow -in Filename.mzML.gz -tr library.pqp -tr_irt
iRTassays.TraML -out_osw Filename.osw -out_chrom Filename.chrom.mzML
```

|     Output files **Filename.osw** and **Filename.chrom.mzML** are required to next steps. Some chromatograms are stored in compressed form and currently inaccesible by `mzR`. In such cases `mzR` would throw an error indicating `Invalid cvParam accession "1002746"`. To avoid this issue, uncompress chromatograms using OpenMS.

```{bash, eval=FALSE}
FileConverter -in Filename.chrom.mzML -in_type 'mzML' -out Filename.chrom.mzML
```

* Step 3: Score features and calculate their q-values. A machine-learning based workflow is available with [PyProphet](http://openswath.org/en/latest/docs/pyprophet.html). For multiplt-runs experiment-wide FDR is recommended. An example of running pyprophet on OpenSWATH results is given below:

```{bash, eval=FALSE}
pyprophet merge --template=library.pqp --out=merged.osw *.osw
pyprophet score --in=merged.osw --classifier=XGBoost --level=ms2 --xeval_num_iter=3 --ss_initial_fdr=0.05 --ss_iteration_fdr=0.01
pyprophet peptide --in=merged.osw --context=experiment-wide
```

|   Congrats! Now we have raw chromatogram files and associated scored features in merged.osw files. Move all .chrom.mzML files in `mzml` directory and merged.osw file in `osw` directory. The parent folder is given as `dataPath` to DIAlignR functions.

## Performing alignment on DIA runs
`alignTargetedRuns` function aligns Proteomics or Metabolomics DIA runs. It expects two directories "osw" and "mzml" at `dataPath`. It outputs an intensity table where rows specify each analyte and columns specify runs. Use parameter `saveFiles = TRUE` to have aligned retetion time and intensities saved in the current directory.

```{r, results=FALSE, message=FALSE, warning=FALSE}
dataPath <- system.file("extdata", package = "DIAlignR")
runs <- c("hroest_K120809_Strep0%PlasmaBiolRepl2_R04_SW_filt", "hroest_K120809_Strep10%PlasmaBiolRepl2_R04_SW_filt")
# For specific runs provide their names.
intensityTbl <- alignTargetedRuns(dataPath = dataPath, runs = runs, analyteInGroupLabel = TRUE, mzPntrs = NULL)
# For specific analytes provide their names.
intensityTbl <- alignTargetedRuns(dataPath = dataPath, runs = NULL, analytes = c("QFNNTDIVLLEDFQK_3"), analyteInGroupLabel = FALSE)
# For all the analytes in all runs, keep them as NULL.
intensityTbl <- alignTargetedRuns(dataPath = dataPath, runs = NULL, analytes = NULL, analyteInGroupLabel = TRUE)
```

## Fetching AlignObj for analytes

For getting alignment object which has aligned indices of XICs `getAlignObjs` function can be used. Like previous function, it expects two directories "osw" and "mzml" at `dataPath`. It performs alignment for exactly two runs. In case of `refRun` is not provided, m-score from osw files is used to select reference run.
```{r, message=FALSE}
dataPath <- system.file("extdata", package = "DIAlignR")
runs <- c("hroest_K120809_Strep0%PlasmaBiolRepl2_R04_SW_filt", "hroest_K120809_Strep10%PlasmaBiolRepl2_R04_SW_filt")
AlignObjLight <- getAlignObjs(analytes = "QFNNTDIVLLEDFQK_3", runs = runs, dataPath = dataPath, objType	= "light")
slotNames(AlignObjLight[["QFNNTDIVLLEDFQK_3"]][[1]])
AlignObjMedium <- getAlignObjs(analytes = "QFNNTDIVLLEDFQK_3", runs = runs, dataPath = dataPath, objType	= "medium")
slotNames(AlignObjMedium[["QFNNTDIVLLEDFQK_3"]][[1]])
```


## Visualizing the aligned chromatograms

We can visualize aligned chromatograms using `plotAlignedAnalytes`. The top figure is experiment unaligned-XICs, middle one is reference XICs, last figure is experiment run aligned to reference.
```{r, fig.width=6, fig.align='center', fig.height=6, message=FALSE}
dataPath <- system.file("extdata", package = "DIAlignR")
runs <- c("hroest_K120809_Strep0%PlasmaBiolRepl2_R04_SW_filt",
 "hroest_K120809_Strep10%PlasmaBiolRepl2_R04_SW_filt")
AlignObj <- getAlignObjs(analytes = "QFNNTDIVLLEDFQK_3", runs = runs, dataPath = dataPath)
plotAlignedAnalytes(AlignObj, annotatePeak = TRUE)
```

## Visualizing the alignment path

We can also visualize the alignment path using `plotAlignemntPath` function.
```{r, fig.width=5, fig.align='center', fig.height=5, message=FALSE}
library(lattice)
dataPath <- system.file("extdata", package = "DIAlignR")
runs <- c("hroest_K120809_Strep0%PlasmaBiolRepl2_R04_SW_filt",
 "hroest_K120809_Strep10%PlasmaBiolRepl2_R04_SW_filt")
AlignObjOutput <- getAlignObjs(analytes = "QFNNTDIVLLEDFQK_3", runs = runs, dataPath = dataPath, objType = "medium")
plotAlignmentPath(AlignObjOutput)
```


## Citation
Gupta S, Ahadi S, Zhou W, Röst H. "DIAlignR Provides Precise Retention Time Alignment Across Distant Runs in DIA and Targeted Proteomics." Mol Cell Proteomics. 2019 Apr;18(4):806-817. doi: https://doi.org/10.1074/mcp.TIR118.001132 

## Last compilation
Last compiled at `r Sys.Date()`.
